<!-- Wappler include head-page="backoffice.html" is="dmx-app" id="boardfunil" appConnect="local" bootstrap5="local" capacitor="local" fontawesome_5="local" components="{dmxStateManagement:{},dmxDataTraversal:{},dmxDatastore:{},dmxBootstrap5Modal:{}}" -->
<div class="modal" id="modal_criar" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar etapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_criar.reset()"></button>
            </div>
            <div class="modal-body">
                <form id="form_criar" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/criar-lista-funil" site="backendMarte" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response+'. Entre em contato com o suporte.')" dmx-on:success="funil_selecionado.load({funil: id_funil_selecionado.value});form_criar.reset();modal_criar.hide();notificacoes.success('Etapa adicionada com sucesso!')">
                    <div class="form-group mb-3"> <label for="nome_list" class="form-label">Nome da etapa</label>
                        <input type="text" class="form-control" id="nome_list" name="nome_list" aria-describedby="input1_help">
                        <input type="hidden" class="form-control" id="board" name="board" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="id_funil_selecionado.value">
                        <input type="hidden" class="form-control" id="empresa_list" name="empresa_list" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="usuario.data.query[0].empresa_selecionada">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_criar.reset()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_criar.submit()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>

<dmx-serverconnect id="funil_selecionado" url="http://localhost:3000/api/listar-funil-selecionado" site="backendMarte" dmx-param:funil="id_funil_selecionado.value"></dmx-serverconnect>
<header class="container-fluid header-azul-escuro align-self-center">
    <div class="container-fluid pt-5">
        <div class="row align-items-start">
            <div class="col align-self-center">
                <h3 class="m-0 text-white">Scrumboard - Funil de vendas</h3>
            </div>
            <div class="col align-self-center text-end">
                <div class="d-flex justify-content-end gap-3"><button id="btn1" class="btn btn-warning" dmx-on:click="navegacao.back()">Votar</button></div>


            </div>
        </div>
    </div>
</header>
<main class="px-4">
    <div class="container-fluid bg-white rounded-4 container-minimo shadow p-4">
        <div class="row bg-white px-3 pt-3 border rounded-3 border-light-subtle m-0">
            <div class="col align-self-center">
                <div class="d-flex justify-content-between align-items-center pb-3 pt-1">
                    <div class="d-flex flex-column gap-2 align-items-start">
                        <h6 class="m-0 badge text-bg-secondary bg-warning">{{view1.funil_selecionado.data.query_board.nome_time}}&nbsp;&nbsp;</h6>
                        <h2 class="m-0">{{view1.funil_selecionado.data.query_board.nome_board}}</h2>
                        <p class="m-0">{{view1.funil_selecionado.data.query_board.descricao_board}}</p>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <button id="btn1" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_criar">Adicionar lista</button>
                    </div>
                </div>
                <div class="d-flex gap-4 py-2 border-top border-light-subtle">
                    <button id="btn2" class="btn px-0">Kunbun</button>
                    <button id="btn3" class="btn px-0">Lista</button>
                </div>



            </div>

        </div>
        <div class="row my-4">
            <div class="col">
                <h5 class="m-0">Etapas do funil</h5>
            </div>
        </div>
        <div is="dmx-repeat" id="repeat_listas" dmx-bind:repeat="funil_selecionado.data.query_board.lists" key="id_board_lists">
            <div class="scrum-column">
                <div class="column-header">
                    <h6 class="column-title">{{nome_list}}</h6>
                    <button class="btn btn-sm btn-outline-primary add-card-btn" type="button">
                        <i class="fas fa-plus"></i> Adicionar card
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Card title</h4>
                        <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                        <a href="#" class="btn btn-warning">Go somewhere</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Implementação do drag-to-scroll horizontal para o scrum board (como no Trello) - VERSÃO CORRIGIDA
function initScrumBoardDragScroll() {
    const scrumBoard = document.getElementById('repeat_listas');
    
    if (!scrumBoard) {
        console.log('Elemento repeat_listas não encontrado');
        return;
    }
    
    console.log('Inicializando drag-to-scroll no elemento:', scrumBoard);
    
    let isDown = false;
    let startX;
    let scrollLeft;
    let moved = false;
    
    // Mouse events
    scrumBoard.addEventListener('mousedown', (e) => {
        console.log('Mouse down detectado', e.target);
        
        // Permitir drag apenas em áreas vazias (não em botões, cards, etc.)
        if (e.target.closest('button, a, input, select, textarea')) {
            console.log('Clique em elemento interativo, ignorando');
            return;
        }
        
        // Permitir drag mesmo nos cards, mas não nos botões dentro deles
        if (e.target.closest('button')) {
            console.log('Clique em botão, ignorando');
            return;
        }
        
        console.log('Iniciando drag');
        isDown = true;
        moved = false;
        scrumBoard.classList.add('dragging');
        startX = e.pageX;
        scrollLeft = scrumBoard.scrollLeft;
        
        // Prevenir seleção de texto
        e.preventDefault();
    });
    
    // Usar document para capturar eventos mesmo quando sair do elemento
    document.addEventListener('mouseleave', () => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
    });
    
    document.addEventListener('mouseup', (e) => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
        console.log('Mouse up, moved:', moved);
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        
        const x = e.pageX;
        const walk = (x - startX) * 1.5; // Velocidade do scroll
        const newScrollLeft = scrollLeft - walk;
        
        scrumBoard.scrollLeft = newScrollLeft;
        moved = true;
        
        console.log('Movendo scroll:', {
            startX: startX,
            currentX: x,
            walk: walk,
            newScrollLeft: newScrollLeft
        });
        
        e.preventDefault();
    });
    
    // Touch events para dispositivos móveis
    scrumBoard.addEventListener('touchstart', (e) => {
        if (e.target.closest('button, a, input, select, textarea')) {
            return;
        }
        
        isDown = true;
        moved = false;
        const touch = e.touches[0];
        startX = touch.pageX;
        scrollLeft = scrumBoard.scrollLeft;
    }, { passive: true });
    
    scrumBoard.addEventListener('touchmove', (e) => {
        if (!isDown) return;
        
        moved = true;
        const touch = e.touches[0];
        const x = touch.pageX;
        const walk = (x - startX) * 1.5;
        scrumBoard.scrollLeft = scrollLeft - walk;
    }, { passive: true });
    
    scrumBoard.addEventListener('touchend', () => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
    }, { passive: true });
    
    console.log('Drag-to-scroll inicializado com sucesso');
}

// Inicializar quando DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrumBoardDragScroll);
} else {
    initScrumBoardDragScroll();
}

// Também tentar inicializar após um pequeno delay caso o elemento seja criado dinamicamente
setTimeout(initScrumBoardDragScroll, 1000);
</script>