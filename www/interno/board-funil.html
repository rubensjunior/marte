<!-- Wappler include head-page="backoffice.html" is="dmx-app" id="boardfunil" appConnect="local" bootstrap5="local" capacitor="local" fontawesome_5="local" components="{dmxStateManagement:{},dmxDataTraversal:{},dmxDatastore:{},dmxBootstrap5Modal:{}}" -->




<div class="modal" id="modal_criar" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Criar etapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_criar.reset()"></button>
            </div>
            <div class="modal-body">
                <form id="form_criar" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/criar-lista-funil" site="backendMarte" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response+'. Entre em contato com o suporte.')" dmx-on:success="funil_selecionado.load({funil: id_funil_selecionado.value});form_criar.reset();modal_criar.hide();notificacoes.success('Etapa adicionada com sucesso!')">
                    <div class="form-group mb-3"> <label for="nome_list" class="form-label">Nome da etapa</label>
                        <input type="text" class="form-control" id="nome_list" name="nome_list" aria-describedby="input1_help">
                        <input type="hidden" class="form-control" id="board" name="board" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="id_funil_selecionado.value">
                        <input type="hidden" class="form-control" id="empresa_list" name="empresa_list" aria-describedby="input1_help" placeholder="Enter some text" dmx-bind:value="usuario.data.query[0].empresa_selecionada">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_criar.reset()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_criar.submit()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal_editar" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar etapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_editar.reset();data_lista_funil.select(0)"></button>
            </div>
            <div class="modal-body">
                <form id="form_editar" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/atualizar-funil-lista" site="backendMarte" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response+'. Entre em contato com o suporte.')" dmx-on:success="funil_selecionado.load({funil: funil.data.id_funil});data_lista_funil.select(0);form_editar.reset();modal_editar.hide();notificacoes.success('Lista atualizada com sucesso!')">

                    <div class="form-group mb-3"> <label for="editar_nome_list" class="form-label">Nome da etapa</label>
                        <input id="id_lista" name="id_lista" type="hidden" class="form-control" dmx-bind:value="data_lista_funil.data.id_board_lists"><input type="text" class="form-control" id="editar_nome_list" name="editar_nome_list" aria-describedby="input1_help" dmx-bind:value="data_lista_funil.data.nome_list">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_editar.reset();data_lista_funil.select(0)">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_editar.submit()">Atualizar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modal_criar_card" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo lead</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="data_lista_funil.select(0);form_criar_lead.reset()"></button>
            </div>
            <div class="modal-body">
                <form id="form_criar_lead">
                    <input id="id_lista" name="id_lista" type="text" class="form-control" dmx-bind:value="data_lista_funil.data.id_board_lists">
                    <div class="form-group mb-3"> <label for="nome" class="form-label">Nome do lead</label>
                        <input type="text" class="form-control" id="nome" name="nome" aria-describedby="input1_help">
                    </div>
                    <div class="form-group mb-3"> <label for="whatsapp" class="form-label">Whatsapp</label>
                        <input type="text" class="form-control" id="whatsapp" name="whatsapp" aria-describedby="input1_help1" placeholder="(11) 99999-9999">
                    </div>
                    <div class="form-group mb-3"> <label for="email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="email" name="email" aria-describedby="input1_help3">
                    </div>
                    <div class="form-group mb-3"> <label for="input3" class="form-label">Curso</label>
                        <select id="cursos" class="form-select" name="cursos" dmx-bind:options="lista_cursos.data.query" optiontext="nome_curso" optionvalue="id_curso">
                            <option selected="" value="">Selecione um curso</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="data_lista_funil.select(0);form_criar_lead.reset()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_criar_lead.submit()">Cadastrar</button>
            </div>
        </div>
    </div>
</div><dmx-serverconnect id="lista_cursos" url="http://localhost:3000/api/listar-cursos" site="backendMarte"></dmx-serverconnect><dmx-serverconnect id="funil_selecionado" url="http://localhost:3000/api/listar-funil-selecionado" site="backendMarte" dmx-param:funil="funil.data.id_funil"></dmx-serverconnect>
<dmx-data-detail id="data_card" dmx-bind:data="funil_selecionado.data.query_board.lists[0].board_cards" key="id_card"></dmx-data-detail><dmx-data-detail id="data_lista_funil" dmx-bind:data="funil_selecionado.data.query_board.lists" key="id_board_lists"></dmx-data-detail>
<header class="container-fluid header-azul-escuro align-self-center">
    <div class="container-fluid pt-5">
        <div class="row align-items-start">
            <div class="col align-self-center">
                <h3 class="m-0 text-white">Scrumboard - Funil de vendas</h3>
            </div>
            <div class="col align-self-center text-end">
                <div class="d-flex justify-content-end gap-3"><button id="btn1" class="btn btn-warning" dmx-on:click="navegacao.back()">Votar</button></div>


            </div>
        </div>
    </div>
</header>
<main class="px-4">
    <div class="container-fluid bg-white rounded-4 container-minimo shadow p-4">
        <div class="row bg-white px-3 pt-3 border rounded-3 border-light-subtle m-0">
            <div class="col align-self-center">
                <div class="d-flex justify-content-between align-items-center pb-3 pt-1">
                    <div class="d-flex flex-column gap-2 align-items-start">
                        <h6 class="m-0 badge text-bg-secondary bg-warning">{{view1.funil_selecionado.data.query_board.nome_time}}&nbsp;&nbsp;</h6>
                        <h2 class="m-0">{{view1.funil_selecionado.data.query_board.nome_board}}</h2>
                        <p class="m-0">{{view1.funil_selecionado.data.query_board.descricao_board}}</p>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <button id="btn1" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_criar">Adicionar lista</button>
                    </div>
                </div>
                <div class="d-flex gap-4 py-2 border-top border-light-subtle">
                    <button id="btn2" class="btn px-0">Kunbun</button>
                    <button id="btn3" class="btn px-0">Lista</button>
                </div>




            </div>

        </div>
        <div class="row my-4">
            <div class="col">
                <h5 class="m-0">Etapas do funil</h5>
            </div>
        </div>
        <div is="dmx-repeat" id="repeat_listas" dmx-bind:repeat="funil_selecionado.data.query_board.lists" key="id_board_lists">
            <div class="scrum-column">
                <div class="column-header">
                    <div class="d-flex justify-content-between mb-3">
                        <h6 class="column-title">{{nome_list}}</h6><i class="far fa-edit curso-ponteiro" dmx-on:click="data_lista_funil.select(id_board_lists);modal_editar.show()"></i>
                    </div>

                    <button class="btn btn-sm btn-outline-primary add-card-btn" type="button" data-bs-toggle="modal" data-bs-target="#modal_criar_card" dmx-on:click="data_lista_funil.select(id_board_lists)">
                        <i class="fas fa-plus"></i> Adicionar card
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Card title</h4>
                        <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                        <a href="#" class="btn btn-warning">Go somewhere</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Implementação do drag-to-scroll horizontal para o scrum board (como no Trello) - VERSÃO CORRIGIDA
function initScrumBoardDragScroll() {
    const scrumBoard = document.getElementById('repeat_listas');
    
    if (!scrumBoard) {
        console.log('Elemento repeat_listas não encontrado');
        return;
    }
    
    console.log('Inicializando drag-to-scroll no elemento:', scrumBoard);
    
    let isDown = false;
    let startX;
    let scrollLeft;
    let moved = false;
    
    // Mouse events
    scrumBoard.addEventListener('mousedown', (e) => {
        console.log('Mouse down detectado', e.target);
        
        // Permitir drag apenas em áreas vazias (não em botões, cards, etc.)
        if (e.target.closest('button, a, input, select, textarea')) {
            console.log('Clique em elemento interativo, ignorando');
            return;
        }
        
        // Permitir drag mesmo nos cards, mas não nos botões dentro deles
        if (e.target.closest('button')) {
            console.log('Clique em botão, ignorando');
            return;
        }
        
        console.log('Iniciando drag');
        isDown = true;
        moved = false;
        scrumBoard.classList.add('dragging');
        startX = e.pageX;
        scrollLeft = scrumBoard.scrollLeft;
        
        // Prevenir seleção de texto
        e.preventDefault();
    });
    
    // Usar document para capturar eventos mesmo quando sair do elemento
    document.addEventListener('mouseleave', () => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
    });
    
    document.addEventListener('mouseup', (e) => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
        console.log('Mouse up, moved:', moved);
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        
        const x = e.pageX;
        const walk = (x - startX) * 1.5; // Velocidade do scroll
        const newScrollLeft = scrollLeft - walk;
        
        scrumBoard.scrollLeft = newScrollLeft;
        moved = true;
        
        console.log('Movendo scroll:', {
            startX: startX,
            currentX: x,
            walk: walk,
            newScrollLeft: newScrollLeft
        });
        
        e.preventDefault();
    });
    
    // Touch events para dispositivos móveis
    scrumBoard.addEventListener('touchstart', (e) => {
        if (e.target.closest('button, a, input, select, textarea')) {
            return;
        }
        
        isDown = true;
        moved = false;
        const touch = e.touches[0];
        startX = touch.pageX;
        scrollLeft = scrumBoard.scrollLeft;
    }, { passive: true });
    
    scrumBoard.addEventListener('touchmove', (e) => {
        if (!isDown) return;
        
        moved = true;
        const touch = e.touches[0];
        const x = touch.pageX;
        const walk = (x - startX) * 1.5;
        scrumBoard.scrollLeft = scrollLeft - walk;
    }, { passive: true });
    
    scrumBoard.addEventListener('touchend', () => {
        isDown = false;
        scrumBoard.classList.remove('dragging');
    }, { passive: true });
    
    console.log('Drag-to-scroll inicializado com sucesso');
}

// Inicializar quando DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrumBoardDragScroll);
} else {
    initScrumBoardDragScroll();
}

// Também tentar inicializar após um pequeno delay caso o elemento seja criado dinamicamente
setTimeout(initScrumBoardDragScroll, 1000);

// Máscara para WhatsApp seguindo padrão brasileiro (11) 99999-9999
function initWhatsAppMask() {
    const whatsappInput = document.getElementById('whatsapp');
    
    if (!whatsappInput) {
        console.log('Input WhatsApp não encontrado');
        return;
    }
    
    console.log('Inicializando máscara do WhatsApp');
    
    // Função para aplicar a máscara
    function applyMask(value) {
        // Remove tudo que não é número
        value = value.replace(/\D/g, '');
        
        // Limita a 11 dígitos (2 DDD + 9 número)
        value = value.substring(0, 11);
        
        // Aplica a máscara progressivamente
        if (value.length >= 2) {
            value = value.replace(/^(\d{2})/, '($1) ');
        }
        if (value.length >= 10) {
            value = value.replace(/^(\(\d{2}\) \d{5})(\d)/, '$1-$2');
        }
        
        return value;
    }
    
    // Event listener para input
    whatsappInput.addEventListener('input', function(e) {
        const cursorPosition = e.target.selectionStart;
        const oldValue = e.target.value;
        const newValue = applyMask(e.target.value);
        
        e.target.value = newValue;
        
        // Ajustar posição do cursor
        if (newValue.length < oldValue.length) {
            e.target.setSelectionRange(cursorPosition, cursorPosition);
        }
    });
    
    console.log('Máscara do WhatsApp inicializada com sucesso');
}

// Inicializar máscara quando DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWhatsAppMask);
} else {
    initWhatsAppMask();
}

// Também tentar inicializar após um pequeno delay caso o elemento seja criado dinamicamente
setTimeout(initWhatsAppMask, 500);
</script>